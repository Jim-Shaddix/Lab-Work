<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of TDMS_readFileHelper_v2</title>
  <meta name="keywords" content="TDMS_readFileHelper_v2">
  <meta name="description" content="TDMS_readFileHelper_v2">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../../menu.html tdms_peak_analysis --><!-- ../../menu.html Store_TDMS_Data --><!-- ../menu.html Matlab_readTDMS_package --><!-- menu.html tdmsSubfunctions -->
<h1>TDMS_readFileHelper_v2
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>TDMS_readFileHelper_v2</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function data = TDMS_readFileHelper_v2(fid,optionStruct,metaStruct,paramsStruct) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">TDMS_readFileHelper_v2</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="TDMS_getTypeSeekSizes.html" class="code" title="function [precisionType,nBytes] = TDMS_getTypeSeekSizes">TDMS_getTypeSeekSizes</a>	TDMS_getTypeSeekSizes  Returns information for fread and fseek</li><li><a href="TDMS_initData.html" class="code" title="function output = TDMS_initData(dataType,nSamples)">TDMS_initData</a>	TDMS_initData  Initializes raw data arrays</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="../../../../tdms_peak_analysis/Store_TDMS_Data/Matlab_readTDMS_package/TDMS_readTDMSFile.html" class="code" title="function [finalOutput,metaStruct] = TDMS_readTDMSFile(tdmsFileName,varargin)">TDMS_readTDMSFile</a>	TDMS_readTDMSFile  Reads TDMS file and does minimal processing to obtain output</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function data = TDMS_readFileHelper_v2(fid,optionStruct,metaStruct,paramsStruct)</a>
0002 <span class="comment">%TDMS_readFileHelper_v2</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%</span>
0005 
0006 SECONDS_IN_DAY  = paramsStruct.SECONDS_IN_DAY;
0007 CONV_FACTOR     = paramsStruct.CONV_FACTOR;
0008 UTC_DIFF        = paramsStruct.UTC_DIFF;
0009 STRING_ENCODING = paramsStruct.STRING_ENCODING;
0010 
0011 <span class="comment">%INPUT UNPACKING</span>
0012 <span class="comment">%==========================================================================</span>
0013 subsetInfo           = optionStruct.subsetInfo;
0014 numValuesToGetActual = optionStruct.numValuesToGetActual;
0015 
0016 rawDataInfo      = metaStruct.rawDataInfo;
0017 segInfo          = metaStruct.segInfo;
0018 
0019 numObjects = length(rawDataInfo);
0020 
0021 <span class="comment">%INITIALIZATION OF OBJECTS</span>
0022 <span class="comment">%==========================================================================</span>
0023 curDataIndex  = zeros(1,numObjects);
0024 data          = cell(1,numObjects);  <span class="comment">%a pointer for each channel</span>
0025 dataTypeArray = [rawDataInfo.dataType];
0026 
0027 <span class="keyword">for</span> iObject = 1:numObjects
0028     <span class="keyword">if</span> numValuesToGetActual(iObject) &gt; 0
0029         data{iObject} = <a href="TDMS_initData.html" class="code" title="function output = TDMS_initData(dataType,nSamples)">TDMS_initData</a>(dataTypeArray(iObject),numValuesToGetActual(iObject));
0030     <span class="keyword">end</span>
0031 <span class="keyword">end</span>
0032 
0033 <span class="comment">%==================================================================</span>
0034 <span class="comment">%                        RAW DATA PROCESSSING</span>
0035 <span class="comment">%==================================================================</span>
0036 precisionType = <a href="TDMS_getTypeSeekSizes.html" class="code" title="function [precisionType,nBytes] = TDMS_getTypeSeekSizes">TDMS_getTypeSeekSizes</a>;
0037 
0038 <span class="keyword">for</span> iRead = 1:size(subsetInfo,1)
0039     
0040     <span class="comment">%This code relies on subsetInfo, which gets defined in</span>
0041     <span class="comment">%TDMS_handleGetDataOption (originally called grabInfo)</span>
0042     
0043     fseek(fid,subsetInfo(iRead,1),<span class="string">'bof'</span>);
0044     
0045     I_object      = subsetInfo(iRead,4);
0046     numValuesRead = subsetInfo(iRead,2);
0047     dataType      = dataTypeArray(I_object);
0048     
0049     startI = curDataIndex(I_object) + 1;
0050     endI   = curDataIndex(I_object) + numValuesRead;
0051     curDataIndex(I_object) = endI;
0052     <span class="keyword">switch</span> dataType
0053         <span class="keyword">case</span> {1 2 3 4 5 6 7 8 9 10} <span class="comment">%numeric</span>
0054             data{I_object}(startI:endI) = fread(fid,numValuesRead,precisionType{dataType});
0055         <span class="keyword">case</span> 32 <span class="comment">%strings</span>
0056             curSeg             = segInfo(subsetInfo(iRead,5));
0057             numValuesAvailable = curSeg.nSamplesRead(curSeg.objOrder == I_object);
0058             strOffsetArray     = [0; fread(fid,numValuesAvailable,<span class="string">'uint32'</span>)];
0059             <span class="keyword">if</span> subsetInfo(iRead,3) ~= 1
0060                <span class="comment">%see TDMS_handleGetDataOption for more info on this</span>
0061                <span class="comment">%need to do some seeking</span>
0062                fseek(fid,strOffsetArray(subsetInfo(iRead,3)),<span class="string">'cof'</span>);
0063             <span class="keyword">end</span>
0064             offsetString = startI - 1;
0065             <span class="keyword">for</span> iString = subsetInfo(iRead,3):subsetInfo(iRead,3)+subsetInfo(iRead,2)-1
0066                 offsetString = offsetString + 1;
0067                 temp         = fread(fid,strOffsetArray(iString+1)-strOffsetArray(iString),<span class="string">'*uint8'</span>);
0068                 data{I_object}{offsetString} = native2unicode(temp,STRING_ENCODING)'; <span class="comment">%#ok&lt;*N2UNI&gt;</span>
0069             <span class="keyword">end</span>
0070         <span class="keyword">case</span> 33 <span class="comment">%boolean</span>
0071             data{I_object}(startI:endI) = logical(fread(fid,numValuesRead,<span class="string">'uint8'</span>));
0072         <span class="keyword">case</span> 68 <span class="comment">%timestamps</span>
0073             temp = fread(fid,numValuesRead*2,<span class="string">'*uint64'</span>);
0074             <span class="comment">%First row: conversion to seconds</span>
0075             <span class="comment">%Second row: conversion to days, and changing of reference frame</span>
0076             data{I_object}(startI:endI) = (double(temp(1:2:end))/2^64 + double(typecast(temp(2:2:end),<span class="string">'int64'</span>)))<span class="keyword">...</span>
0077                 /SECONDS_IN_DAY + CONV_FACTOR + UTC_DIFF/24;
0078         <span class="keyword">otherwise</span>
0079             error(<span class="string">'Unexpected type: %d'</span>, dataType)
0080     <span class="keyword">end</span>
0081 <span class="keyword">end</span>
0082 
0083 <span class="comment">%ERROR CHECKING ON # OF VALUES READ</span>
0084 <span class="comment">%==========================================================================</span>
0085 <span class="keyword">if</span> ~isequal(numValuesToGetActual,curDataIndex)
0086     error(<span class="string">'The # of requested values does not equal the # of returned values, error in code likely'</span>)
0087 <span class="keyword">end</span>
0088 <span class="comment">%numValuesToGetActual vs curDataIndex</span>
0089 
0090 <span class="comment">%END OF READING RAW DATA</span>
0091 <span class="comment">%==========================================================================</span>
0092 fclose(fid);</pre></div>
<hr><address>Generated on Sun 19-Aug-2018 19:01:02 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>